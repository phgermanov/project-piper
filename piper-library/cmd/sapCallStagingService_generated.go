// Code generated by piper's step-generator. DO NOT EDIT.

package cmd

import (
	"fmt"
	"os"
	"path/filepath"
	"time"

	piperOsCmd "github.com/SAP/jenkins-library/cmd"
	"github.com/SAP/jenkins-library/pkg/config"
	"github.com/SAP/jenkins-library/pkg/gcp"
	"github.com/SAP/jenkins-library/pkg/log"
	"github.com/SAP/jenkins-library/pkg/piperenv"
	"github.com/SAP/jenkins-library/pkg/splunk"
	"github.com/SAP/jenkins-library/pkg/telemetry"
	"github.com/SAP/jenkins-library/pkg/validation"
	"github.com/spf13/cobra"
)

type sapCallStagingServiceOptions struct {
	Action              string   `json:"action,omitempty" validate:"possible-values=createGroup createRepository createRepositories updateGroupMetadata close promote getRepositoryCredentials getRepositoryBom getGroupMetadata getRepositoryMetadata updateRepositoryMetadata searchGroupMetadata getGroupBom signGroup"`
	DockerConfigJSON    string   `json:"dockerConfigJSON,omitempty"`
	Username            string   `json:"username,omitempty"`
	Password            string   `json:"password,omitempty"`
	TenantID            string   `json:"tenantId,omitempty"`
	TenantSecret        string   `json:"tenantSecret,omitempty"`
	Timeout             int      `json:"timeout,omitempty"`
	Profile             string   `json:"profile,omitempty"`
	Metadata            string   `json:"metadata,omitempty"`
	Url                 string   `json:"url,omitempty"`
	OutputFile          string   `json:"outputFile,omitempty"`
	RepositoryID        string   `json:"repositoryId,omitempty"`
	MavenBuildArtifacts string   `json:"mavenBuildArtifacts,omitempty"`
	NpmBuildArtifacts   string   `json:"npmBuildArtifacts,omitempty"`
	MtaBuildArtifacts   string   `json:"mtaBuildArtifacts,omitempty"`
	GroupID             string   `json:"groupId,omitempty"`
	RepositoryFormat    string   `json:"repositoryFormat,omitempty"`
	RepositoryFormats   []string `json:"repositoryFormats,omitempty" validate:"possible-values=docker helm maven npm pypi raw"`
	GroupIDFile         string   `json:"groupIdFile,omitempty"`
	Query               string   `json:"query,omitempty"`
	State               string   `json:"state,omitempty"`
	BuildTool           string   `json:"buildTool,omitempty" validate:"possible-values=golang gradle helm maven mta npm pip docker CAP"`
	ArtifactPattern     string   `json:"artifactPattern,omitempty"`
	CommitID            string   `json:"commitId,omitempty"`
	HeadCommitID        string   `json:"headCommitId,omitempty"`
	GitURL              string   `json:"gitURL,omitempty"`
}

type sapCallStagingServiceCommonPipelineEnvironment struct {
	container struct {
		registryURL        string
		repositoryUsername string
		repositoryPassword string
	}
	custom struct {
		dockerConfigJSON        string
		helmRepositoryURL       string
		helmRepositoryUsername  string
		helmRepositoryPassword  string
		mavenGlobalSettingsFile string
		mavenRepositoryURL      string
		mavenRepositoryUsername string
		mavenRepositoryPassword string
		npmRepositoryURL        string
		npmRepositoryUsername   string
		npmRepositoryPassword   string
		pipRepositoryURL        string
		pipRepositoryUsername   string
		pipRepositoryPassword   string
		rawRepositoryURL        string
		rawRepositoryUsername   string
		rawRepositoryPassword   string
		stagingGroupID          string
		stagingRepositoryID     string
		repositoryURL           string
		repositoryID            string
		repositoryFormat        string
		repositoryUsername      string
		repositoryPassword      string
		stagedArtifactURLs      []string
		promotedArtifactURLs    []string
		promotedDockerImages    []string
		helmChartURL            string
		releaseStatus           string
	}
}

func (p *sapCallStagingServiceCommonPipelineEnvironment) persist(path, resourceName string) {
	content := []struct {
		category string
		name     string
		value    interface{}
	}{
		{category: "container", name: "registryUrl", value: p.container.registryURL},
		{category: "container", name: "repositoryUsername", value: p.container.repositoryUsername},
		{category: "container", name: "repositoryPassword", value: p.container.repositoryPassword},
		{category: "custom", name: "dockerConfigJSON", value: p.custom.dockerConfigJSON},
		{category: "custom", name: "helmRepositoryURL", value: p.custom.helmRepositoryURL},
		{category: "custom", name: "helmRepositoryUsername", value: p.custom.helmRepositoryUsername},
		{category: "custom", name: "helmRepositoryPassword", value: p.custom.helmRepositoryPassword},
		{category: "custom", name: "mavenGlobalSettingsFile", value: p.custom.mavenGlobalSettingsFile},
		{category: "custom", name: "mavenRepositoryURL", value: p.custom.mavenRepositoryURL},
		{category: "custom", name: "mavenRepositoryUsername", value: p.custom.mavenRepositoryUsername},
		{category: "custom", name: "mavenRepositoryPassword", value: p.custom.mavenRepositoryPassword},
		{category: "custom", name: "npmRepositoryURL", value: p.custom.npmRepositoryURL},
		{category: "custom", name: "npmRepositoryUsername", value: p.custom.npmRepositoryUsername},
		{category: "custom", name: "npmRepositoryPassword", value: p.custom.npmRepositoryPassword},
		{category: "custom", name: "pipRepositoryURL", value: p.custom.pipRepositoryURL},
		{category: "custom", name: "pipRepositoryUsername", value: p.custom.pipRepositoryUsername},
		{category: "custom", name: "pipRepositoryPassword", value: p.custom.pipRepositoryPassword},
		{category: "custom", name: "rawRepositoryURL", value: p.custom.rawRepositoryURL},
		{category: "custom", name: "rawRepositoryUsername", value: p.custom.rawRepositoryUsername},
		{category: "custom", name: "rawRepositoryPassword", value: p.custom.rawRepositoryPassword},
		{category: "custom", name: "stagingGroupId", value: p.custom.stagingGroupID},
		{category: "custom", name: "stagingRepositoryId", value: p.custom.stagingRepositoryID},
		{category: "custom", name: "repositoryUrl", value: p.custom.repositoryURL},
		{category: "custom", name: "repositoryId", value: p.custom.repositoryID},
		{category: "custom", name: "repositoryFormat", value: p.custom.repositoryFormat},
		{category: "custom", name: "repositoryUsername", value: p.custom.repositoryUsername},
		{category: "custom", name: "repositoryPassword", value: p.custom.repositoryPassword},
		{category: "custom", name: "stagedArtifactUrls", value: p.custom.stagedArtifactURLs},
		{category: "custom", name: "promotedArtifactUrls", value: p.custom.promotedArtifactURLs},
		{category: "custom", name: "promotedDockerImages", value: p.custom.promotedDockerImages},
		{category: "custom", name: "helmChartUrl", value: p.custom.helmChartURL},
		{category: "custom", name: "releaseStatus", value: p.custom.releaseStatus},
	}

	errCount := 0
	for _, param := range content {
		err := piperenv.SetResourceParameter(path, resourceName, filepath.Join(param.category, param.name), param.value)
		if err != nil {
			log.Entry().WithError(err).Error("Error persisting piper environment.")
			errCount++
		}
	}
	if errCount > 0 {
		log.Entry().Error("failed to persist Piper environment")
	}
}

// SapCallStagingServiceCommand This step is related to staging service.
func SapCallStagingServiceCommand() *cobra.Command {
	const STEP_NAME = "sapCallStagingService"

	metadata := sapCallStagingServiceMetadata()
	var stepConfig sapCallStagingServiceOptions
	var startTime time.Time
	var commonPipelineEnvironment sapCallStagingServiceCommonPipelineEnvironment
	var logCollector *log.CollectorHook
	var splunkClient *splunk.Splunk
	telemetryClient := &telemetry.Telemetry{}

	var createSapCallStagingServiceCmd = &cobra.Command{
		Use:   STEP_NAME,
		Short: "This step is related to staging service.",
		Long: `With this step you can use the general functionalities of [staging service](https://github.wdf.sap.corp/pages/Repository-services/staging-service/).

With the parameter ` + "`" + `action` + "`" + ` you can choose between following tasks:

- createGroup : Specifying this option, the step will create a staging group. You must specify ` + "`" + `profile` + "`" + ` parameter.
- createRepository: This action will create a repository. You must specify ` + "`" + `outputFile` + "`" + ` where this step will store the repository info and pass ` + "`" + `groupIdFile` + "`" + ` name where groupId was stored.
- updateGroupMetadata: This action will update group metadata. You must specify ` + "`" + `metadata` + "`" + ` and ` + "`" + `groupIdFile` + "`" + `.
- close: This action will close the staging group. You must specify ` + "`" + `groupIdFile` + "`" + `.
- promote: This action will promote your group. You must specify ` + "`" + `groupIdFile` + "`" + `.
- getRepositoryCredentials: This action will get repository credentials and store them in a file. You must specify ` + "`" + `repositoryId` + "`" + ` and ` + "`" + `groupIdFile` + "`" + `.
- getGroupBom: This action will get group bom and store it in a file. You must specify ` + "`" + `groupIdFile` + "`" + ` and ` + "`" + `outputFile` + "`" + `.
- getRepositoryBom: This action will get repository bom and store it in a file. You must specify ` + "`" + `repositoryId` + "`" + `, ` + "`" + `groupIdFile` + "`" + ` and ` + "`" + `outputFile` + "`" + `.
- getGroupMetadata: This action will get the metadata for a group. You must specify ` + "`" + `groupIdFile` + "`" + ` and ` + "`" + `outputFile` + "`" + `.
- getRepositoryMetadata: This action will get the metadata for a repository. You must specify ` + "`" + `repositoryId` + "`" + `, ` + "`" + `groupIdFile` + "`" + ` and ` + "`" + `outputFile` + "`" + `.
- updateRepositoryMetadata: This action will update the metadata for specific repository. You must specify ` + "`" + `repositoryId` + "`" + `, ` + "`" + `groupIdFile` + "`" + ` and ` + "`" + `metadata` + "`" + `.
- searchGroupMetadata: This action will search inside the group's metadata. You must specify ` + "`" + `outputFile` + "`" + `, ` + "`" + `groupIdFile` + "`" + `, ` + "`" + `query` + "`" + ` and if you want state of group.
- signGroup: This action will sign a group. You must specify ` + "`" + `groupIdFile` + "`" + `.

To use this step you must pass ` + "`" + `username` + "`" + `, ` + "`" + `password` + "`" + `, ` + "`" + `tenantId` + "`" + `, ` + "`" + `tenantSecret` + "`" + ` for authentication to the staging service. **Remark: this is typically done via Jenkins credentials or credentials retrieved from [Vault](https://vault.tools.sap/).
You must also pass the url for the staging api.`,
		PreRunE: func(cmd *cobra.Command, _ []string) error {
			startTime = time.Now()
			log.SetStepName(STEP_NAME)
			log.SetVerbose(piperOsCmd.GeneralConfig.Verbose)

			piperOsCmd.GeneralConfig.GitHubAccessTokens = piperOsCmd.ResolveAccessTokens(piperOsCmd.GeneralConfig.GitHubTokens)

			path, err := os.Getwd()
			if err != nil {
				return err
			}
			fatalHook := &log.FatalHook{CorrelationID: piperOsCmd.GeneralConfig.CorrelationID, Path: path}
			log.RegisterHook(fatalHook)

			err = piperOsCmd.PrepareConfig(cmd, &metadata, STEP_NAME, &stepConfig, config.OpenPiperFile)
			if err != nil {
				log.SetErrorCategory(log.ErrorConfiguration)
				return err
			}

			// Set step error patterns for improved error detection
			stepErrors := make([]log.StepError, len(metadata.Metadata.Errors))
			for i, err := range metadata.Metadata.Errors {
				stepErrors[i] = log.StepError{
					Pattern:  err.Pattern,
					Message:  err.Message,
					Category: err.Category,
				}
			}
			log.SetStepErrors(stepErrors)
			log.RegisterSecret(stepConfig.DockerConfigJSON)
			log.RegisterSecret(stepConfig.Username)
			log.RegisterSecret(stepConfig.Password)
			log.RegisterSecret(stepConfig.TenantID)
			log.RegisterSecret(stepConfig.TenantSecret)

			if len(piperOsCmd.GeneralConfig.HookConfig.SentryConfig.Dsn) > 0 {
				sentryHook := log.NewSentryHook(piperOsCmd.GeneralConfig.HookConfig.SentryConfig.Dsn, piperOsCmd.GeneralConfig.CorrelationID)
				log.RegisterHook(&sentryHook)
			}

			if len(piperOsCmd.GeneralConfig.HookConfig.SplunkConfig.Dsn) > 0 || len(piperOsCmd.GeneralConfig.HookConfig.SplunkConfig.ProdCriblEndpoint) > 0 {
				splunkClient = &splunk.Splunk{}
				logCollector = &log.CollectorHook{CorrelationID: piperOsCmd.GeneralConfig.CorrelationID}
				log.RegisterHook(logCollector)
			}

			if err = log.RegisterANSHookIfConfigured(piperOsCmd.GeneralConfig.CorrelationID); err != nil {
				log.Entry().WithError(err).Warn("failed to set up SAP Alert Notification Service log hook")
			}

			validation, err := validation.New(validation.WithJSONNamesForStructFields(), validation.WithPredefinedErrorMessages())
			if err != nil {
				return err
			}
			if err = validation.ValidateStruct(stepConfig); err != nil {
				log.SetErrorCategory(log.ErrorConfiguration)
				return err
			}

			return nil
		},
		Run: func(_ *cobra.Command, _ []string) {
			vaultClient := config.GlobalVaultClient()
			if vaultClient != nil {
				defer vaultClient.MustRevokeToken()
			}

			stepTelemetryData := telemetry.CustomData{}
			stepTelemetryData.ErrorCode = "1"
			handler := func() {
				commonPipelineEnvironment.persist(piperOsCmd.GeneralConfig.EnvRootPath, "commonPipelineEnvironment")
				config.RemoveVaultSecretFiles()
				stepTelemetryData.Duration = fmt.Sprintf("%v", time.Since(startTime).Milliseconds())
				stepTelemetryData.ErrorCategory = log.GetErrorCategory().String()
				stepTelemetryData.PiperCommitHash = piperOsCmd.GitCommit
				telemetryClient.SetData(&stepTelemetryData)
				telemetryClient.LogStepTelemetryData()
				if len(piperOsCmd.GeneralConfig.HookConfig.SplunkConfig.Dsn) > 0 {
					splunkClient.Initialize(piperOsCmd.GeneralConfig.CorrelationID,
						piperOsCmd.GeneralConfig.HookConfig.SplunkConfig.Dsn,
						piperOsCmd.GeneralConfig.HookConfig.SplunkConfig.Token,
						piperOsCmd.GeneralConfig.HookConfig.SplunkConfig.Index,
						piperOsCmd.GeneralConfig.HookConfig.SplunkConfig.SendLogs)
					splunkClient.Send(telemetryClient.GetData(), logCollector)
				}
				if len(piperOsCmd.GeneralConfig.HookConfig.SplunkConfig.ProdCriblEndpoint) > 0 {
					splunkClient.Initialize(piperOsCmd.GeneralConfig.CorrelationID,
						piperOsCmd.GeneralConfig.HookConfig.SplunkConfig.ProdCriblEndpoint,
						piperOsCmd.GeneralConfig.HookConfig.SplunkConfig.ProdCriblToken,
						piperOsCmd.GeneralConfig.HookConfig.SplunkConfig.ProdCriblIndex,
						piperOsCmd.GeneralConfig.HookConfig.SplunkConfig.SendLogs)
					splunkClient.Send(telemetryClient.GetData(), logCollector)
				}
				if piperOsCmd.GeneralConfig.HookConfig.GCPPubSubConfig.Enabled {
					err := gcp.NewGcpPubsubClient(
						vaultClient,
						piperOsCmd.GeneralConfig.HookConfig.GCPPubSubConfig.ProjectNumber,
						piperOsCmd.GeneralConfig.HookConfig.GCPPubSubConfig.IdentityPool,
						piperOsCmd.GeneralConfig.HookConfig.GCPPubSubConfig.IdentityProvider,
						piperOsCmd.GeneralConfig.CorrelationID,
						piperOsCmd.GeneralConfig.HookConfig.OIDCConfig.RoleID,
					).Publish(piperOsCmd.GeneralConfig.HookConfig.GCPPubSubConfig.Topic, telemetryClient.GetDataBytes())
					if err != nil {
						log.Entry().WithError(err).Warn("event publish failed")
					}
				}
			}
			log.DeferExitHandler(handler)
			defer handler()
			telemetryClient.Initialize(STEP_NAME)
			sapCallStagingService(stepConfig, &stepTelemetryData, &commonPipelineEnvironment)
			stepTelemetryData.ErrorCode = "0"
			log.Entry().Info("SUCCESS")
		},
	}

	addSapCallStagingServiceFlags(createSapCallStagingServiceCmd, &stepConfig)
	return createSapCallStagingServiceCmd
}

func addSapCallStagingServiceFlags(cmd *cobra.Command, stepConfig *sapCallStagingServiceOptions) {
	cmd.Flags().StringVar(&stepConfig.Action, "action", os.Getenv("PIPER_action"), "You can choose what this step to do for you.You can choose between createGroup,createRepository,close,promote,updateGroupMetadata,getRepositoryCredentials and getRepositoryBom.")
	cmd.Flags().StringVar(&stepConfig.DockerConfigJSON, "dockerConfigJSON", os.Getenv("PIPER_dockerConfigJSON"), "Path to the file `.docker/config.json` - this is typically provided by your CI/CD system. You can find more details about the Docker credentials in the [Docker documentation](https://docs.docker.com/engine/reference/commandline/login/).")
	cmd.Flags().StringVar(&stepConfig.Username, "username", os.Getenv("PIPER_username"), "This username in combination with password and tenant credentials authenticates you in staging service.")
	cmd.Flags().StringVar(&stepConfig.Password, "password", os.Getenv("PIPER_password"), "This password in combination with username and tenant credentials authenticates you in staging service.")
	cmd.Flags().StringVar(&stepConfig.TenantID, "tenantId", os.Getenv("PIPER_tenantId"), "This tenantId in combination with username,password and tenantSecret authenticates you in staging service.")
	cmd.Flags().StringVar(&stepConfig.TenantSecret, "tenantSecret", os.Getenv("PIPER_tenantSecret"), "This tenantSecret in combination with username,password and tenantId authenticates you in staging service.")
	cmd.Flags().IntVar(&stepConfig.Timeout, "timeout", 900, "Timeout in seconds until an HTTP call is forcefully terminated.")
	cmd.Flags().StringVar(&stepConfig.Profile, "profile", os.Getenv("PIPER_profile"), "Staging profile for working flow")
	cmd.Flags().StringVar(&stepConfig.Metadata, "metadata", os.Getenv("PIPER_metadata"), "Metadata that will be set")
	cmd.Flags().StringVar(&stepConfig.Url, "url", `http://nexus.wdf.sap.corp:8443/stage`, "Url for staging service api")
	cmd.Flags().StringVar(&stepConfig.OutputFile, "outputFile", `staging_output_deprecated.json`, "Name of file that will be created and used for storing new info.")
	cmd.Flags().StringVar(&stepConfig.RepositoryID, "repositoryId", os.Getenv("PIPER_repositoryId"), "Name of repository for which we want to get the credentials.")
	cmd.Flags().StringVar(&stepConfig.MavenBuildArtifacts, "mavenBuildArtifacts", os.Getenv("PIPER_mavenBuildArtifacts"), "Build coordinates from maven build step, provided from pipeline environment and it's used by PPMS through [pipeline events](https://go.sap.corp/piper/news/2024/06/10/pipeline-events-for-cumulus/).")
	cmd.Flags().StringVar(&stepConfig.NpmBuildArtifacts, "npmBuildArtifacts", os.Getenv("PIPER_npmBuildArtifacts"), "Build coordinates from npmExecuteScripts step, provided from pipeline environment and it's used by PPMS through [pipeline events](https://go.sap.corp/piper/news/2024/06/10/pipeline-events-for-cumulus/).")
	cmd.Flags().StringVar(&stepConfig.MtaBuildArtifacts, "mtaBuildArtifacts", os.Getenv("PIPER_mtaBuildArtifacts"), "Build coordinates from mtaBuild step, provided from pipeline environment and it's used by PPMS through [pipeline events](https://go.sap.corp/piper/news/2024/06/10/pipeline-events-for-cumulus/).")
	cmd.Flags().StringVar(&stepConfig.GroupID, "groupId", os.Getenv("PIPER_groupId"), "Defines the id of the staging service group.")
	cmd.Flags().StringVar(&stepConfig.RepositoryFormat, "repositoryFormat", os.Getenv("PIPER_repositoryFormat"), "Repository format example:docker,maven,npm")
	cmd.Flags().StringSliceVar(&stepConfig.RepositoryFormats, "repositoryFormats", []string{}, "List of repository types to be created.")
	cmd.Flags().StringVar(&stepConfig.GroupIDFile, "groupIdFile", os.Getenv("PIPER_groupIdFile"), "**Deprecated**: Path to the file that stores the staging groupId. Please use `groupId` instead.")
	cmd.Flags().StringVar(&stepConfig.Query, "query", os.Getenv("PIPER_query"), "Query parameter to search in metadata")
	cmd.Flags().StringVar(&stepConfig.State, "state", os.Getenv("PIPER_state"), "State of group")
	cmd.Flags().StringVar(&stepConfig.BuildTool, "buildTool", os.Getenv("PIPER_buildTool"), "Defines the tool which is used for building the artifact.")
	cmd.Flags().StringVar(&stepConfig.ArtifactPattern, "artifactPattern", os.Getenv("PIPER_artifactPattern"), "Defines a pattern (glob style) to select the artifact(s) exported to the pipeline environment (e.g. '{*.war,*.zip}', '*.jar').")
	cmd.Flags().StringVar(&stepConfig.CommitID, "commitId", os.Getenv("PIPER_commitId"), "CommitId of the current build. If a tag is build in artifactPrepareVersion step then this is tag commit id.")
	cmd.Flags().StringVar(&stepConfig.HeadCommitID, "headCommitId", os.Getenv("PIPER_headCommitId"), "CommitId of the current build.")
	cmd.Flags().StringVar(&stepConfig.GitURL, "gitURL", os.Getenv("PIPER_gitURL"), "Git URL of the repository.")

	cmd.MarkFlagRequired("action")
	cmd.MarkFlagRequired("username")
	cmd.MarkFlagRequired("password")
	cmd.MarkFlagRequired("tenantId")
	cmd.MarkFlagRequired("tenantSecret")
	cmd.MarkFlagRequired("url")
}

// retrieve step metadata
func sapCallStagingServiceMetadata() config.StepData {
	var theMetaData = config.StepData{
		Metadata: config.StepMetadata{
			Name:        "sapCallStagingService",
			Aliases:     []config.Alias{},
			Description: "This step is related to staging service.",
			Errors: []config.StepError{
				{
					Pattern:  "request to .*/stage/api/login returned with response 404 Not Found",
					Message:  "Staging service login endpoint not found (404). Check if the staging service URL is correct and the service is available.",
					Category: "service_unavailable",
				},
			},
		},
		Spec: config.StepSpec{
			Inputs: config.StepInputs{
				Secrets: []config.StepSecrets{
					{Name: "dockerConfigJsonCredentialsId", Description: "Jenkins 'Secret file' credentials ID containing Docker config.json (with registry credential(s)). You can create it like explained in the Docker Success Center in the article about [how to generate a new auth in the config.json file](https://success.docker.com/article/generate-new-auth-in-config-json-file).", Type: "jenkins"},
					{Name: "stagingTenantCredentialsId", Description: "Jenkins 'Username with password' credentials ID containing tenantId and secret for authentication to staging service", Type: "jenkins"},
					{Name: "stagingUserCredentialsId", Description: "Jenkins 'Username with password' credentials ID containing username and password for authentication to staging service", Type: "jenkins"},
				},
				Parameters: []config.StepParameters{
					{
						Name:        "action",
						ResourceRef: []config.ResourceReference{},
						Scope:       []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:        "string",
						Mandatory:   true,
						Aliases:     []config.Alias{},
						Default:     os.Getenv("PIPER_action"),
					},
					{
						Name: "dockerConfigJSON",
						ResourceRef: []config.ResourceReference{
							{
								Name: "dockerConfigJsonCredentialsId",
								Type: "secret",
							},

							{
								Name:    "dockerConfigJsonCredentialsVaultSecretName",
								Type:    "vaultSecretFile",
								Default: "docker-config",
							},
						},
						Scope:     []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:      "string",
						Mandatory: false,
						Aliases:   []config.Alias{},
						Default:   os.Getenv("PIPER_dockerConfigJSON"),
					},
					{
						Name: "username",
						ResourceRef: []config.ResourceReference{
							{
								Name:  "stagingUserCredentialsId",
								Param: "username",
								Type:  "secret",
							},

							{
								Name:    "stagingUserCredentialsVaultSecretName",
								Type:    "vaultSecret",
								Default: "staging-service",
							},
						},
						Scope:     []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:      "string",
						Mandatory: true,
						Aliases:   []config.Alias{},
						Default:   os.Getenv("PIPER_username"),
					},
					{
						Name: "password",
						ResourceRef: []config.ResourceReference{
							{
								Name:  "stagingUserCredentialsId",
								Param: "password",
								Type:  "secret",
							},

							{
								Name:    "stagingUserCredentialsVaultSecretName",
								Type:    "vaultSecret",
								Default: "staging-service",
							},
						},
						Scope:     []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:      "string",
						Mandatory: true,
						Aliases:   []config.Alias{},
						Default:   os.Getenv("PIPER_password"),
					},
					{
						Name: "tenantId",
						ResourceRef: []config.ResourceReference{
							{
								Name:  "stagingTenantCredentialsId",
								Param: "username",
								Type:  "secret",
							},

							{
								Name:    "stagingTenantCredentialsVaultSecretName",
								Type:    "vaultSecret",
								Default: "staging-service",
							},
						},
						Scope:     []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:      "string",
						Mandatory: true,
						Aliases:   []config.Alias{},
						Default:   os.Getenv("PIPER_tenantId"),
					},
					{
						Name: "tenantSecret",
						ResourceRef: []config.ResourceReference{
							{
								Name:  "stagingTenantCredentialsId",
								Param: "password",
								Type:  "secret",
							},

							{
								Name:    "stagingTenantCredentialsVaultSecretName",
								Type:    "vaultSecret",
								Default: "staging-service",
							},
						},
						Scope:     []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:      "string",
						Mandatory: true,
						Aliases:   []config.Alias{},
						Default:   os.Getenv("PIPER_tenantSecret"),
					},
					{
						Name:        "timeout",
						ResourceRef: []config.ResourceReference{},
						Scope:       []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:        "int",
						Mandatory:   false,
						Aliases:     []config.Alias{},
						Default:     900,
					},
					{
						Name:        "profile",
						ResourceRef: []config.ResourceReference{},
						Scope:       []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:        "string",
						Mandatory:   false,
						Aliases:     []config.Alias{},
						Default:     os.Getenv("PIPER_profile"),
					},
					{
						Name:        "metadata",
						ResourceRef: []config.ResourceReference{},
						Scope:       []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:        "string",
						Mandatory:   false,
						Aliases:     []config.Alias{},
						Default:     os.Getenv("PIPER_metadata"),
					},
					{
						Name:        "url",
						ResourceRef: []config.ResourceReference{},
						Scope:       []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:        "string",
						Mandatory:   true,
						Aliases:     []config.Alias{},
						Default:     `http://nexus.wdf.sap.corp:8443/stage`,
					},
					{
						Name:        "outputFile",
						ResourceRef: []config.ResourceReference{},
						Scope:       []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:        "string",
						Mandatory:   false,
						Aliases:     []config.Alias{},
						Default:     `staging_output_deprecated.json`,
					},
					{
						Name: "repositoryId",
						ResourceRef: []config.ResourceReference{
							{
								Name:  "commonPipelineEnvironment",
								Param: "custom/stagingRepositoryId",
							},
						},
						Scope:     []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:      "string",
						Mandatory: false,
						Aliases:   []config.Alias{},
						Default:   os.Getenv("PIPER_repositoryId"),
					},
					{
						Name: "mavenBuildArtifacts",
						ResourceRef: []config.ResourceReference{
							{
								Name:  "commonPipelineEnvironment",
								Param: "custom/mavenBuildArtifacts",
							},
						},
						Scope:     []string{"PARAMETERS"},
						Type:      "string",
						Mandatory: false,
						Aliases:   []config.Alias{},
						Default:   os.Getenv("PIPER_mavenBuildArtifacts"),
					},
					{
						Name: "npmBuildArtifacts",
						ResourceRef: []config.ResourceReference{
							{
								Name:  "commonPipelineEnvironment",
								Param: "custom/npmBuildArtifacts",
							},
						},
						Scope:     []string{"PARAMETERS"},
						Type:      "string",
						Mandatory: false,
						Aliases:   []config.Alias{},
						Default:   os.Getenv("PIPER_npmBuildArtifacts"),
					},
					{
						Name: "mtaBuildArtifacts",
						ResourceRef: []config.ResourceReference{
							{
								Name:  "commonPipelineEnvironment",
								Param: "custom/mtaBuildArtifacts",
							},
						},
						Scope:     []string{"PARAMETERS"},
						Type:      "string",
						Mandatory: false,
						Aliases:   []config.Alias{},
						Default:   os.Getenv("PIPER_mtaBuildArtifacts"),
					},
					{
						Name: "groupId",
						ResourceRef: []config.ResourceReference{
							{
								Name:  "commonPipelineEnvironment",
								Param: "custom/stagingGroupId",
							},
						},
						Scope:     []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:      "string",
						Mandatory: false,
						Aliases:   []config.Alias{},
						Default:   os.Getenv("PIPER_groupId"),
					},
					{
						Name:        "repositoryFormat",
						ResourceRef: []config.ResourceReference{},
						Scope:       []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:        "string",
						Mandatory:   false,
						Aliases:     []config.Alias{},
						Default:     os.Getenv("PIPER_repositoryFormat"),
					},
					{
						Name:        "repositoryFormats",
						ResourceRef: []config.ResourceReference{},
						Scope:       []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:        "[]string",
						Mandatory:   false,
						Aliases:     []config.Alias{},
						Default:     []string{},
					},
					{
						Name:        "groupIdFile",
						ResourceRef: []config.ResourceReference{},
						Scope:       []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:        "string",
						Mandatory:   false,
						Aliases:     []config.Alias{},
						Default:     os.Getenv("PIPER_groupIdFile"),
					},
					{
						Name:        "query",
						ResourceRef: []config.ResourceReference{},
						Scope:       []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:        "string",
						Mandatory:   false,
						Aliases:     []config.Alias{},
						Default:     os.Getenv("PIPER_query"),
					},
					{
						Name:        "state",
						ResourceRef: []config.ResourceReference{},
						Scope:       []string{"PARAMETERS", "STAGES", "STEPS"},
						Type:        "string",
						Mandatory:   false,
						Aliases:     []config.Alias{},
						Default:     os.Getenv("PIPER_state"),
					},
					{
						Name:        "buildTool",
						ResourceRef: []config.ResourceReference{},
						Scope:       []string{"GENERAL", "PARAMETERS", "STAGES", "STEPS"},
						Type:        "string",
						Mandatory:   false,
						Aliases:     []config.Alias{},
						Default:     os.Getenv("PIPER_buildTool"),
					},
					{
						Name:        "artifactPattern",
						ResourceRef: []config.ResourceReference{},
						Scope:       []string{"GENERAL", "PARAMETERS", "STAGES", "STEPS"},
						Type:        "string",
						Mandatory:   false,
						Aliases:     []config.Alias{},
						Default:     os.Getenv("PIPER_artifactPattern"),
					},
					{
						Name: "commitId",
						ResourceRef: []config.ResourceReference{
							{
								Name:  "commonPipelineEnvironment",
								Param: "git/commitId",
							},
						},
						Scope:     []string{"PARAMETERS"},
						Type:      "string",
						Mandatory: false,
						Aliases:   []config.Alias{},
						Default:   os.Getenv("PIPER_commitId"),
					},
					{
						Name: "headCommitId",
						ResourceRef: []config.ResourceReference{
							{
								Name:  "commonPipelineEnvironment",
								Param: "git/headCommitId",
							},
						},
						Scope:     []string{"PARAMETERS"},
						Type:      "string",
						Mandatory: false,
						Aliases:   []config.Alias{},
						Default:   os.Getenv("PIPER_headCommitId"),
					},
					{
						Name: "gitURL",
						ResourceRef: []config.ResourceReference{
							{
								Name:  "commonPipelineEnvironment",
								Param: "git/url",
							},
						},
						Scope:     []string{"PARAMETERS"},
						Type:      "string",
						Mandatory: false,
						Aliases:   []config.Alias{},
						Default:   os.Getenv("PIPER_gitURL"),
					},
				},
			},
			Outputs: config.StepOutputs{
				Resources: []config.StepResources{
					{
						Name: "commonPipelineEnvironment",
						Type: "piperEnvironment",
						Parameters: []map[string]interface{}{
							{"name": "container/registryUrl"},
							{"name": "container/repositoryUsername"},
							{"name": "container/repositoryPassword"},
							{"name": "custom/dockerConfigJSON"},
							{"name": "custom/helmRepositoryURL"},
							{"name": "custom/helmRepositoryUsername"},
							{"name": "custom/helmRepositoryPassword"},
							{"name": "custom/mavenGlobalSettingsFile"},
							{"name": "custom/mavenRepositoryURL"},
							{"name": "custom/mavenRepositoryUsername"},
							{"name": "custom/mavenRepositoryPassword"},
							{"name": "custom/npmRepositoryURL"},
							{"name": "custom/npmRepositoryUsername"},
							{"name": "custom/npmRepositoryPassword"},
							{"name": "custom/pipRepositoryURL"},
							{"name": "custom/pipRepositoryUsername"},
							{"name": "custom/pipRepositoryPassword"},
							{"name": "custom/rawRepositoryURL"},
							{"name": "custom/rawRepositoryUsername"},
							{"name": "custom/rawRepositoryPassword"},
							{"name": "custom/stagingGroupId"},
							{"name": "custom/stagingRepositoryId"},
							{"name": "custom/repositoryUrl"},
							{"name": "custom/repositoryId"},
							{"name": "custom/repositoryFormat"},
							{"name": "custom/repositoryUsername"},
							{"name": "custom/repositoryPassword"},
							{"name": "custom/stagedArtifactUrls", "type": "[]string"},
							{"name": "custom/promotedArtifactUrls", "type": "[]string"},
							{"name": "custom/promotedDockerImages", "type": "[]string"},
							{"name": "custom/helmChartUrl"},
							{"name": "custom/releaseStatus"},
						},
					},
				},
			},
		},
	}
	return theMetaData
}

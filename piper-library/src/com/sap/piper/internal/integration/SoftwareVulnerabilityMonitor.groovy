package com.sap.piper.internal.integration

import com.sap.icd.jenkins.Utils

class SoftwareVulnerabilityMonitor implements Serializable {

    final Utils utils
    final Script script
    final Map config
    String baseUrl

    SoftwareVulnerabilityMonitor(Script script, Utils utils, Map config) {
        this.script = script
        this.utils = utils
        this.config = config
        if (!config.svmServerUrl || !config.svmEndpoint)
            this.script.error "Parameters 'serverUrl' and 'svmEndpoint' must be provided as part of the configuration."
        this.baseUrl = "${config.svmServerUrl}${config.svmEndpoint}/"
    }

    void fetchExemptionFile(targetPath) {
        def body = [[workspace: [token: this.config.vulasSpaceToken]]]
        def targetProperties = "${targetPath}${this.config.svmExemptionFileName}"
        httpSvm("xsjs/assessments/download.xsjs?format=mavenVulas", body, 'POST', targetProperties)
        if (this.config.verbose) {
            this.script.echo "Fetched exemption file for Vulas space ${this.config.vulasSpaceToken}"
        }
        script.archiveArtifacts artifacts: targetProperties.replaceAll('\\./', ''), allowEmptyArchive: true
    }

     void updateRecentWhiteSourceProjectInSvm(List svmWhiteSourceList){
        def body = svmWhiteSourceList
        httpSVMPost("xsjs/toolsDataFetch/executeToolsDataFetch.xsjs?tool=whitesource", body, 'POST')
        if (this.config.verbose) {
            this.script.echo "Updating WhiteSource Application in SVM ${svmWhiteSourceList}"
        }
    }

    void updateRecentVulasAppInSVM(List svmVulasList){
        def body = svmVulasList
        httpSVMPost("xsjs/toolsDataFetch/executeToolsDataFetch.xsjs?tool=vulas", body, 'POST')
         if (this.config.verbose) {
            this.script.echo "Updating Vulas Applications in SVM ${svmVulasList}"
        }
    }
    
    private httpSvm(path, body = null, mode = 'GET', outputFile = null) {
        def params = [
            url                    : "${this.baseUrl}${path}",
            httpMode               : mode,
            authentication         : this.config.svmCredentialsId,
            contentType            : 'APPLICATION_JSON',
            quiet                  : !this.config.verbose,
            ignoreSslErrors        : true,
            consoleLogResponseBody : this.config.verbose
        ]
        if(body) params += [requestBody : this.utils.jsonToString(body)]
        if(outputFile) params += [outputFile : outputFile]

        def response = this.script.httpRequest(params)
        return response
    }

     private httpSVMPost(path, body, mode = 'POST'){
        def params = [
            url                    : "${this.baseUrl}${path}",
            httpMode               : mode,
            contentType            : 'APPLICATION_JSON',
            quiet                  : !this.config.verbose,
            ignoreSslErrors        : true,
            consoleLogResponseBody : this.config.verbose
        ]
        if(body) params += [requestBody : this.utils.jsonToString(body)]

        def response = this.script.httpRequest(params)
        return response
    }

}

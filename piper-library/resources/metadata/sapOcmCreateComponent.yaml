metadata:
  name: sapOcmCreateComponent
  description: Create an Open-Component-Model component-version
  longDescription: |
    This step creates a component-version of the Open-Component-Model (OCM).
    For more information about OCM see <https://ocm.software>.
    Currently only (multi-)container builds (incl. single helm-chart) are supported.

    You can run this step either fully automated or in a customized way. In fully automated mode all information is taken from the pipeline configuration. The step generates a `component-constructor.yaml` file and calls [the OCM CLI](https://github.com/open-component-model/ocm/blob/main/docs/reference/ocm.md) to create the component-version. Some parameters (see below) can be set to control certain fields. In customized mode you provide your own `component-constructor.yaml` file in the source tree. The step detects if such a file exists and uses this instead of creating one. Default is `component-constructor.yaml` in the root directory. This file usually will be a template where certain variables will be replaced with values from the pipeline configuration. This step is by default disabled for pull requests, but can be enabled by configuration.

    The following variables are available:

    ```
    componentConstructorPath --> path to your custom component-constructor.yaml file
    artifactVersion          --> version of this artifact
    componentName            --> name of the component
    containerRegistryURL     --> OCI registry of the build artifacts
    containerRegistry        --> OCI registry - same as containerRegistryURL but without protocol
    genDir                   --> path to directory where generated files are created
    gitCommitId              --> commit hash in Git used for this build
    gitOrg                   --> organization in Git
    gitRepository            --> name of repository in Git
    gitURL                   --> URL to Git repository
    imageNames               --> array of image names (multi-image)
    imageNameTags            --> array of name and tag (multi-image)
    provider                 --> provider name of component version (default: SAP SE (gitOrg))
    OCI_NAME_0               --> name of the OCI image (multi-image: 0, 1, ...)
    OCI_REFERENCE_0          --> reference to the OCI image (multi-image: 0, 1, ...)
    OCI_VERSION_0            --> version of the OCI image (multi-image: 0, 1, ...)
    HELM_CHART               --> name of the helm chart if helm chart was build in a previous step
    HELM_VERSION             --> version of helm chart if helm chart was build in a previous step
    HELM_REPOSITORY          --> repository, where the helm chart is hosted
    helmChartURL             --> URL to helm chart if helm chart was build in a previous step (helmExecute: true)
    ```

    Here is an example:

    ```
    componentConstructorPath: gen/component-constructor.yaml
    artifactVersion: 0.0.1-dev-20240918153148+97feb5d34cebc31a8f9c56c8cd4fd8ff8003cd1e
    componentName: open-component-model.sap.com/hello-ocm-helm
    containerRegistryURL: https://f464b1e28081-20231025-131529839-554.staging.repositories.cloud.sap
    containerRegistry: 371000438081-20240918-153224737-816.staging.repositories.cloud.sap
    force: true
    genDir: ./gen
    gitCommitId: 97feb5d34cebc31a8f9c56c8cd4fd8ff8003cd1e
    gitOrg: open-component-model
    gitRepository: hello-ocm-helm
    gitURL: https://github.tools.sap/open-component-model/hello-ocm-helm
    imageNames:
      - hello-ocm-helm
    imageNameTags:
      - hello-ocm-helm:0.0.1-dev-20240918153148_97feb5d34cebc31a8f9c56c8cd4fd8ff8003cd1e
    provider: SAP SE (open-component-model)
    OCI_NAME_0: hello-ocm-helm
    OCI_REFERENCE_0: 371000108081-20240924-072300486-87.staging.repositories.cloud.sap/hello-ocm-helm:0.0.1-dev-20240924072222_7e63e6490e8a5d47ee14ca12500ad7aeea854b90
    OCI_VERSION_0: 0.0.1-dev-20240924072222+7e63e6490e8a5d47ee14ca12500ad7aeea854b90
    HELM_CHART: hello-ocm-helm
    HELM_VERSION: 0.0.1-dev
    HELM_REPOSITORY: https://staging.repositories.cloud.sap/stage/repository/371000698081-20240918-153224840-252
    helmChartURL: https://staging.repositories.cloud.sap/stage/repository/371000698081-20240918-153224840-252/hello-ocm-helm-0.0.1-dev.tgz
    ```

    An example `component-constructor.yaml` using some of these variables:

    ```
    components:
    - name: ${componentName}
      version: ${artifactVersion}
      provider:
        name: ${provider}
      sources:
      - name: src
        type: filesystem
        access:
          type: gitHub
          repoURL: ${gitURL}
          commit: ${gitCommitId}
      resources:
      - name: ${OCI_NAME_0}
        type: ociImage
        version: ${artifactVersion}
        access:
          type: ociArtifact
          imageReference: ${OCI_REFERENCE_0}
      - name: ${HELM_CHART}
          type: helmChart
          version: ${artifactVersion}
          access:
            type: helm
            helmChart: ${HELM_CHART}
            helmRepository: ${HELM_REPOSITORY}
            version: ${HELM_VERSION}
    ```

    The created component-constructor + settings are stored as output from this step as yaml string.

    So, `sapOcmCreateComponent` supports two major use cases:
    1. Scenario: `sapOcmCreateComponent` runs as the last build step and generates OCM component descriptors for the artifacts built by the previous steps of the same pipeline run.
    2. Scenario: `sapOcmCreateComponent` runs as the only tool and assembles OCM components and artifacts built elsewhere (not the current pipeline) to a bigger package.
    The latter case can be configured as follows in the `config.yml`:
    ```
    general:
      buildTool: custom
      nativeBuild: true
      cnbBuild: false
    stages:
      Build:
        sapOcmCreateComponent: true
    steps:
      sapOcmCreateComponent:
        componentConstructorPath: some/path/my-ocm-component.yaml
      sapCallStagingService:
        buildTool: docker
    ```

    Notes:

    The version numbers generated by piper are not semver compatible. They are converted to a semver
    compatible syntax.

    [Starting point for developer documentation](https://github.wdf.sap.corp/ContinuousDelivery/piper-library/blob/main/pkg/sap/ocm/README.md)

spec:
  inputs:
    secrets:
      - name: dockerConfigJsonCredentialsId
        description: Secret file credentials ID containing Docker config.json. The file will be passed to OCM toolkit, to connect to private OCI registries.
        type: jenkins
    params:
      - name: dockerConfigJSON
        type: string
        description: Path to the file `.docker/config.json` - the file contains credentials required to access private OCI registries.
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        secret: true
        resourceRef:
          - name: commonPipelineEnvironment
            param: custom/dockerConfigJSON
          - name: dockerConfigJsonCredentialsId
            type: secret
          - type: vaultSecretFile
            default: docker-config
            name: dockerConfigFileVaultSecretName
      - name: componentConstructorPath
        description: "Path to component-constructor.yaml file"
        type: string
        scope:
          - PARAMETERS
          - STEPS
      - name: enableOnPr
        description: "True if ocm step is enabled on pull-request builds"
        type: bool
        default: false
        scope:
          - PARAMETERS
          - STEPS
      - name: provider
        description: "The provider name to be used in the component descriptor"
        type: string
        scope:
          - PARAMETERS
          - STEPS
      - name: componentName
        description: |
          The component name to be used in the component descriptor.
          If not set, it's constructed by: [github_org].sap.com/[github_repo].
          It has to match the regular expression: `^[a-z][-a-z0-9]*([.][a-z][-a-z0-9]*)*[.][a-z]{2,}(/[a-z][-a-z0-9_]*([.][a-z][-a-z0-9_]*)*)+$`
        type: string
        scope:
          - PARAMETERS
          - STEPS
      - name: failOnError
        description: "Indicates if the build should fail if component descriptor can not be generated"
        type: bool
        default: true
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: genDir
        description: "Path where generated files get written"
        type: string
        default: gen
        scope:
          - PARAMETERS
          - STEPS
      # commonPipelineEnvironment
      - name: artifactVersion
        description: "The version assigned by artifactPrepareVersion to the uploaded artifact"
        type: string
        resourceRef:
          - name: commonPipelineEnvironment
            param: artifactVersion
        scope:
          - PARAMETERS
          - STEPS
      - name: gitRepository
        description: "The name of the git repository"
        type: string
        resourceRef:
          - name: commonPipelineEnvironment
            param: git/repository
      - name: gitCommitId
        description: "The commit id of the git repository"
        type: string
        resourceRef:
          - name: commonPipelineEnvironment
            param: git/commitId
      - name: gitOrg
        description: "The organization of the git repository"
        type: string
        resourceRef:
          - name: commonPipelineEnvironment
            param: git/organization
      - name: gitURL
        description: "The URL of the git repository"
        type: string
        resourceRef:
          - name: commonPipelineEnvironment
            param: git/url
      # xMake
      - name: promotedArtifactURLs
        description: "Promoted artifact urls"
        type: "[]string"
        resourceRef:
          - name: commonPipelineEnvironment
            param: custom/promotedArtifactUrls
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      # container
      - name: imageNames
        description: "List of image names"
        type: "[]string"
        resourceRef:
          - name: commonPipelineEnvironment
            param: container/imageNames
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: imageNameTags
        description: "List of image name tags"
        type: "[]string"
        resourceRef:
          - name: commonPipelineEnvironment
            param: container/imageNameTags
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: containerRegistryURL
        description: "The URL of the container registry"
        type: string
        resourceRef:
          - name: commonPipelineEnvironment
            param: container/registryUrl
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: containerRegistryUser
        description: "The user of the container registry"
        type: string
        secret: true
        resourceRef:
          - name: commonPipelineEnvironment
            param: container/repositoryUsername
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: containerRegistryPassword
        description: "The password of the container registry"
        type: string
        secret: true
        resourceRef:
          - name: commonPipelineEnvironment
            param: container/repositoryPassword
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      # helm
      - name: helmChartURL
        description: "The URL to the helm chart from a helmExecute output"
        type: string
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        resourceRef:
          - name: commonPipelineEnvironment
            param: custom/helmChartUrl
      - name: helmRepositoryUsername
        description: "Username for the helm repository where the compiled helm .tgz archive shall be uploaded - typically provided by the CI/CD environment"
        type: string
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        secret: true
        resourceRef:
          - name: commonPipelineEnvironment
            param: custom/helmRepositoryUsername
      - name: helmRepositoryPassword
        description: "Password for the helm repository where the compiled helm .tgz archive shall be uploaded - typically provided by the CI/CD environment"
        type: string
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        secret: true
        resourceRef:
          - name: commonPipelineEnvironment
            param: custom/helmRepositoryPassword
          - name: commonPipelineEnvironment
            param: custom/repositoryPassword
      # staging
      - name: stagingGroupID
        description: "Defines the id of the staging service group"
        type: string
        resourceRef:
          - name: commonPipelineEnvironment
            param: custom/stagingGroupId
      - name: stagingServiceRepositoryUser
        description: "Username for the repository created from staging services"
        type: string
        resourceRef:
          - name: commonPipelineEnvironment
            param: custom/repositoryUsername
      - name: stagingServiceRepositoryPassword
        description: "Password for the repository created from staging services"
        type: string
        secret: true
        resourceRef:
          - name: commonPipelineEnvironment
            param: custom/repositoryPassword
  containers:
    - image: ghcr.io/open-component-model/piper-ocm-cli:0.31.0
  outputs:
    resources:
      - name: ocm
        type: generated
        params:
          - filePattern: "**/component-constructor.yaml"
            type: ocm
          - filePattern: "**/settings.yaml"
            type: ocm
      - name: commonPipelineEnvironment
        type: piperEnvironment
        params:
          - name: custom/componentConstructor
          - name: custom/settingsYaml
          - name: custom/componentDescriptor
          - name: custom/ocmStagingRepo
          - name: custom/isCustomComponentDescriptor
            type: bool

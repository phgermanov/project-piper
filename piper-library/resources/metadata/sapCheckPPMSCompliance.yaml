metadata:
  name: sapCheckPPMSCompliance
  aliases:
    - name: detectExecuteScan
    - name: executePPMSComplianceCheck
      deprecated: true
    - name: executePPMSWhitesourceComplianceCheck
      deprecated: true
  description: This step is related to Free and Open Source Software (FOSS) in your development project (your delivery).
  longDescription: |-
    This step is related to Free and Open Source Software (FOSS) in your development project (your delivery).
    It cross-checks that you have declared all FOSS of your development project in the corresponding model of your delivery in PPMS (usually a build version (BV) in your software component version (SCV)).

    It will fetch PPMS FOSS IDs based on your current WhiteSource or BlackDuck scan results as well as the PPMS FOSS entries contained in your PPMS SCV.
    Then it will map both by using the PPMS FOSS ID.
    The step will fail if the BOM in PPMS deviates from the BOM identified via WhiteSource or BlackDuck, unless the automatic PPMS upload functionality is switched on.

    In case some FOSS identified via WhiteSource or BlackDuck do not have a counterpart in PPMS yet (= no PPMS FOSS ID known), the upload to PPMS will happen nevertheless **in accordance to the [Licensing Product standard guidelines](https://wiki.wdf.sap.corp/wiki/x/az4siQ) which prefer up-to-date declarations over completeness**.

    Execution will generate a report, which shows the missing FOSS entries. If automatic PPMS upload is not configured, you can directly use the appended link to request the declaration for your software component version.
    The report will also contain the risk rating for the found PPMS FOSS entries.

    !!! tip "Recommendation: activate automatic PPMS uploads"
        It is highly recommended to activate the automatic upload of PPMS change requests as well as the automatic creation of PPMS build versions.

        This helps you to have an unattended process without manual interventions.

    !!! note "For usage with WhiteSource: this step requires a WhiteSource product token"
        This step requires a WhiteSource product token in order to query the WhiteSource system for product details!

        Since a WhiteSource product token is also required for the WhiteSource scan it is best to maintain the parameter `whitesourceProductToken` in the `general` section of the configuration.

    !!! note "For usage with BlackDuck: custom serverUrl should use alias parameter name"
        If you are using a server different from the default value and have configured the BlackDuck parameters
        in the 'detectExecuteScan' step's configs, please use the alias 'detectServerUrl' instead of 'serverUrl' to set the URL.
        Using custom 'serverUrl' in pipelines may conflict with the serverUrl of the PPMS step.
spec:
  inputs:
    secrets:
      - name: whitesourceUserTokenCredentialsId
        type: jenkins
      - name: ppmsCredentialsId
        type: jenkins
      - name: detectTokenCredentialsId
        aliases:
          - name: blackduckTokenCredentialsId
        description: Jenkins 'Secret text' credentials ID containing the API token used to authenticate with the Synopsis Detect (formerly BlackDuck) Server.
        type: jenkins
      - name: githubTokenCredentialsId
        description: Jenkins 'Secret text' credentials ID containing token to authenticate to GitHub.
        type: jenkins
    params:
      - name: assignees
        description: Defines the assignees for the Github Issue created/updated with the results of the scan as a list of login names.
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        type: "[]string"
        default: []
      - name: blackduckProjectName
        aliases:
          - name: projectName
        type: string
        description: Name of the BlackDuck project which should be used for comparison (mandatory when using BlackDuck).
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
      - name: blackduckProjectNames
        aliases:
          - name: projectNames
        type: "[]string"
        description: Names of BlackDuck projects which should be used for comparison. [If this parameter is used - it overrides blackduckProjectName parameter].
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
      - name: buildVersion
        aliases:
          - name: ppmsBuildVersion
        type: string
        description: PPMS build version of affected PPMS software component version.
        longDescription: |-
          Makes it possible to run the check against a dedicated build version of a SCV.<br />
          **Please note:**<br />
          1) Build versions are only available for PPMS SCVs<br />
          2) If a SCV has build versions activated, the check is always performed against a build version<br />
          3) If no build version is maintained, the check is performed against the latest build version.

          The value of this parameter can be either a fixed value or a template. The template allows
          to consume the following version information: `.Major`, `.Minor`, `.Patch`, `.Timestamp`.<br />
          If no value is provided, the following template will be used: `{{.Major}}.{{.Minor}}.{{.Patch}}`.
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: buildVersionEndpoint
        aliases:
          - name: ppmsBuildVersionEndpoint
        type: string
        description: API endpoint for PPMS Build Version API
        mandatory: true
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: /sap/internal/ppms/api/changerequest/v1/cvbv
      - name: changeRequestEndpoint
        aliases:
          - name: ppmsChangeRequestEndpoint
        type: string
        description: API endpoint for PPMS Change Request API
        mandatory: true
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: /sap/internal/ppms/api/changerequest/v1/cvpart
      - name: changeRequestFileName
        type: string
        description: Name of the file containing the PPMS change request document
        mandatory: true
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: piper_foss-changerequest.json
      - name: channelID
        aliases:
          - name: ppmsChannelID
        type: string
        description: ID of the PPMS Go-to-market channel
        mandatory: true
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: GTMC_10
      - name: customScanVersion
        type: string
        description: Custom version of the BlackDuck project used as source.
        longDescription: |-
          Defines a custom version for the BlackDuck scan which deviates from the typical versioning pattern using [`version`](#version) and [`versioningModel`](#versioningmodel)
          It allows to set non-numeric versions as well and supersedes the value of [`version`](#version) which is calculated automatically.
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
      - name: createBuildVersion
        aliases:
          - name: ppmsBuildVersionCreation
        type: bool
        description: Defines if a new build version should be created in PPMS based on value available for `ppmsBuildVersion`.
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: createResultIssue
        type: bool
        description: Activate creation of a result issue in GitHub.
        longDescription: |
          Whether the step creates a GitHub issue containing the scan results in the originating repo.
          Since optimized pipelines are headless the creation is implicitly activated for scheduled runs.
        resourceRef:
          - name: commonPipelineEnvironment
            param: custom/isOptimizedAndScheduled
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: false
      - name: detectServerUrl
        type: string
        description: URL to the Synopsis Detect (formerly BlackDuck) Server.
        longDescription: |
          If you are using a server different from the default value and have configured the BlackDuck parameters
          in the 'detectExecuteScan' step's configs, please use the alias 'detectServerUrl' instead of 'serverUrl' to set the URL.
          Using 'serverUrl' in custom pipelines may conflict with the serverUrl of the PPMS system.
        mandatory: true
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
        default: https://sap.blackducksoftware.com
      - name: detectToken
        aliases:
          - name: blackduckToken
          - name: token
        type: string
        description: API token to be used for connectivity with Synopsis Detect server - aka BlackDuck (mandatory when using Detect/BlackDuck).
        secret: true
        resourceRef:
          - name: detectTokenCredentialsId
            type: secret
          - type: vaultSecret
            name: detectTokenCredentialsVaultSecretName
            default: detect
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
      - name: githubApiUrl
        description: "Set the GitHub API URL."
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
        type: string
        default: "https://api.github.com"
      - name: githubToken
        description: "GitHub personal access token as per
          https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line"
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
        type: string
        secret: true
        aliases:
          - name: access_token
        resourceRef:
          - name: githubTokenCredentialsId
            type: secret
          - type: vaultSecret
            default: github
            name: githubVaultSecretName
      - name: orgToken
        type: string
        description: Whitesource organization token (mandatory when using WhiteSource).
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
        default: 6971b2eec2d3420bad0caf173ec629f6a3c7d3ba63f3445ab99ffdbf1acfb1d0
      - name: owner
        aliases:
          - name: githubOrg
        description: "Set the GitHub organization."
        resourceRef:
          - name: commonPipelineEnvironment
            param: github/owner
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
        type: string
      - name: password
        type: string
        description: Password for PPMS system. In Jenkins environment automatically set based on credentials.
        mandatory: true
        secret: true
        resourceRef:
          - name: ppmsCredentialsId
            type: secret
            param: password
          - type: vaultSecret
            name: ppmsCredentialsVaultSecretName
            default: ppms
        aliases:
          - name: ppmsPassword
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: ppmsID
        type: string
        description: PPMS object number of PPMS software component version or PPMS product version to which the found FOSS objects are compared. If you want to use the PPMS change request upload functionality, please make sure to use a PPMS software component version.
        mandatory: true
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
      - name: pullRequestMode
        type: bool
        description: Defines if verification takes place in pull-request voting. In this case upload request to PPMS will be skipped.
        scope:
          - STAGES
      - name: reportFileName
        type: string
        description: "[Deprecated] File name of the generated comparison report is now automatically determined by the step."
        mandatory: false
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: piper_whitesource_ppms_report
        deprecated: true
      - name: reportName
        type: string
        description: Name of the report which will be available in Jenkins.
        mandatory: false
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: PPMS Compliance Check Report
      - name: reportTitle
        type: string
        description: Title of the generated report. If empty, `reportName` value will be used.
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: repository
        aliases:
          - name: githubRepo
        description: "Set the GitHub repository."
        resourceRef:
          - name: commonPipelineEnvironment
            param: github/repository
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
        type: string
      - name: serverUrl
        aliases:
          - name: ppmsServerUrl
        type: string
        description: HTTPS server URL for PPMS system
        mandatory: true
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: https://i7p.wdf.sap.corp
      - name: timeout
        type: int
        description: "Timeout in seconds until an HTTP call is forcefully terminated."
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: 900
      - name: uploadChangeRequest
        aliases:
          - name: ppmsChangeRequestUpload
        type: bool
        description: Defines if a change request document should be uploaded to PPMS based on the comparison results.
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: username
        type: string
        description: User name for PPMS system. In Jenkins environment automatically set based on credentials.
        mandatory: true
        secret: true
        resourceRef:
          - name: ppmsCredentialsId
            type: secret
            param: username
          - type: vaultSecret
            name: ppmsCredentialsVaultSecretName
            default: ppms
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        aliases:
          - name: ppmsUsername
      - name: userToken
        aliases:
          - name: whitesourceUserToken
        type: string
        secret: true
        description: User token to access WhiteSource (mandatory when using WhiteSource). In Jenkins use case this is automatically filled through the credentials.
        resourceRef:
          - name: whitesourceUserTokenCredentialsId
            type: secret
          - type: vaultSecret
            name: whitesourceUserTokenCredentialsVaultSecretName
            default: whitesource
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
      - name: version
        aliases:
          - name: projectVersion
        type: string
        description: Defines the version number of the artifact being build in the pipeline. It is used for build version creation and as source for the BlackDuck version.
        longDescription: |-
          Defines the version number of the artifact being build in the pipeline.
          It is used for build version creation and as source for the BlackDuck version.
          **Typically it is available through the pipeline run.**
          For BlackDuck version the value is used in combination with the parameter [`versioningModel`](#versioningmodel) to calculate the version of the BlackDuck project.
        resourceRef:
          - name: commonPipelineEnvironment
            param: artifactVersion
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: versioningModel
        aliases:
          - name: defaultVersioningModel
        type: string
        description: The default project versioning model used for BlackDuck project versioning based on parameter `version`.
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: major
        possibleValues:
          - major
          - major-minor
          - semantic
          - full
      - name: whitesourceProductName
        type: string
        description: Name of the WhiteSource product used for comparison.
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
      - name: whitesourceProductToken
        type: string
        description: Token of the WhiteSource product used for comparison (mandatory when using WhiteSource).
        longDescription: "Alternatively, also a `whitesourceProductName` could be provided."
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
      - name: whitesourceProjectNames
        type: "[]string"
        description: List of WhiteSource projects used for comparison - typically provided automatically.
        resourceRef:
          - name: commonPipelineEnvironment
            param: custom/whitesourceProjectNames
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
      - name: whitesourceProjectNamesPattern
        type: string
        description: A pattern to select whitesource projects for comparison.
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
      - name: runComplianceCheckWithDetect
        type: bool
        description: Boolean flag to indicate Detect (Blackduck) scan instead of Whitesource to be used for PPMS compliance check.
        longDescription: |
          Piper automatically identifies the scan to be considered for PPMS check based on whitesource or detect credentials passed via config/env/vault.
          By default, Piper considers Whitesource scan. However, for use cases where Detect (Blackduck) scan is preferred for PPMS compliance check,
          this flag should be set to true to let Piper know of your Detect (Blackduck) preference.
        scope:
          - PARAMETERS
          - STEPS
          - STAGES
          - GENERAL
        default: false
  outputs:
    resources:
      - name: influx
        type: influx
        params:
          - name: step_data
            fields:
              - name: ppms
      - name: reports
        type: reports
        params:
          - filePattern: "**/piper_whitesource_ppms_report.*"
            type: whitesource-ip
          - filePattern: "**/piper_blackduck_ppms_report.*"
            type: blackduck-ip
